#include <Wire.h>
#include "HCPCA9685.h"

#define PCA_ADDR 0x40
#define MPU_ADDR 0x68

HCPCA9685 pca(PCA_ADDR);

// Servo pulse range
#define SERVO_MIN 150
#define SERVO_MAX 450

// Flex calibration
int thumbMin  = 160, thumbMax  = 270;
int indexMin  = 175, indexMax  = 320;
int middleMin = 150, middleMax = 270;
int ringMin   = 200, ringMax   = 290;
int pinkyMin  = 280, pinkyMax  = 840;

// Wrist range (gyro)
int wristMin = -16000;
int wristMax = 16000;

// MPU values
int16_t AcX, AcY, AcZ, GyX, GyY, GyZ;

void setup() {
  Wire.begin();
  Serial.begin(9600);

  // PCA9685
  pca.Init(SERVO_MODE);
  pca.Sleep(false);

  // MPU6050 wake
  Wire.beginTransmission(MPU_ADDR);
  Wire.write(0x6B);
  Wire.write(0);
  Wire.endTransmission(true);

  pinMode(A0, INPUT);
  pinMode(A1, INPUT);
  pinMode(A2, INPUT);
  pinMode(A3, INPUT);
  pinMode(A4, INPUT);
}

void loop() {
  moveFinger(A0, thumbMin,  thumbMax,  0);
  moveFinger(A1, indexMin,  indexMax,  1);
  moveFinger(A2, middleMin, middleMax, 2);
  moveFinger(A3, ringMin,   ringMax,   3);
  moveFinger(A4, pinkyMin,  pinkyMax,  4);

  readMPU();
  moveWrist(GyX, 5);

  delay(20);
}

void moveFinger(int pin, int minVal, int maxVal, int channel) {
  int val = analogRead(pin);
  val = constrain(val, minVal, maxVal);

  int pos = map(val, minVal, maxVal, SERVO_MIN, SERVO_MAX);
  pca.Servo(channel, pos);
}

void readMPU() {
  Wire.beginTransmission(MPU_ADDR);
  Wire.write(0x3B);
  Wire.endTransmission(false);
  Wire.requestFrom(MPU_ADDR, 14, true);

  AcX = Wire.read() << 8 | Wire.read();
  AcY = Wire.read() << 8 | Wire.read();
  AcZ = Wire.read() << 8 | Wire.read();
  Wire.read(); Wire.read(); // temp
  GyX = Wire.read() << 8 | Wire.read();
  GyY = Wire.read() << 8 | Wire.read();
  GyZ = Wire.read() << 8 | Wire.read();
}

void moveWrist(int gyroVal, int channel) {
  gyroVal = constrain(gyroVal, wristMin, wristMax);
  int pos = map(gyroVal, wristMin, wristMax, SERVO_MIN, SERVO_MAX);
  pca.Servo(channel, pos);
}vo(4, Pos);
}
